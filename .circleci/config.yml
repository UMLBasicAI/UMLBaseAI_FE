version: 2.1

orbs:
  node: circleci/node@5.1.0

executors:
  node-executor:
    docker:
      - image: cimg/node:18.20
    working_directory: ~/project

jobs:
  build:
    executor: node-executor
    steps:
      - checkout

      - run:
          name: Install dependencies
          command: npm install --loglevel=error --no-fund --no-audit

      - run:
          name: SonarCloud Scan
          command: |
            curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip sonar-scanner.zip
            export PATH=$PATH:$PWD/sonar-scanner-5.0.1.3006-linux/bin

            sonar-scanner \
              -Dsonar.projectKey=UMLBasicAI_UMLBaseAI_FE \
              -Dsonar.organization=umlbasicai \
              -Dsonar.sources=. \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$SONAR_TOKEN

      - run:
          name: Build Next.js frontend
          command: npm run build

      - persist_to_workspace:
          root: .
          paths:
            - .next
            - public
            - package.json
            - package-lock.json
            - node_modules
            - ecosystem.config.js
            - next.config.mjs
            - src
            - tsconfig.json
            - tailwind.config.ts
            - postcss.config.mjs

  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - add_ssh_keys:
          fingerprints:
            - "SHA256:l773R58oKSwz7pggORkLHL2XxUko5EMWHOMuu2AvS/8"

      - attach_workspace:
          at: ~/project

      - run:
          name: Create .env.production from ENV_PROD_BASE64
          command: |
            echo "$ENV_PROD_BASE64" | base64 --decode > ~/project/.env.production

      - run:
          name: Ensure rsync is installed on VPS
          command: |
            ssh -o StrictHostKeyChecking=no adminplantuml@20.189.124.231 \<< 'EOF'
              if ! command -v rsync &> /dev/null; then
                echo "Installing rsync..."
                sudo apt-get update && sudo apt-get install -y rsync
              else
                echo "rsync is already installed."
              fi
            EOF

      - run:
          name: Sync project files to VPS using rsync
          command: |
            APP_DIR="/home/adminplantuml/apps/umlbasicai-fe/production"

            ssh -o StrictHostKeyChecking=no adminplantuml@20.189.124.231 \<<EOF
              mkdir -p $APP_DIR
              which rsync || (sudo apt update && sudo apt install rsync -y)
            EOF

            rsync -avz --delete \
              -e "ssh -o StrictHostKeyChecking=no" \
              ~/project/.env.production \
              ~/project/ \
              adminplantuml@20.189.124.231:$APP_DIR

      - run:
          name: Install deps & build on VPS
          command: |
            ssh -o StrictHostKeyChecking=no adminplantuml@20.189.124.231 \<<EOF
              cd /home/adminplantuml/apps/umlbasicai-fe/production
              npm install --loglevel=error --no-fund --no-audit
              npm run build
            EOF

      - run:
          name: Restart with PM2
          command: |
            ssh -o StrictHostKeyChecking=no adminplantuml@20.189.124.231 \<<EOF
              cd /home/adminplantuml/apps/umlbasicai-fe/production
              pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
            EOF

workflows:
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
