trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '18.x'
  ZIP_NAME: 'umlbasicai-fe.zip'
  APP_DIR: '/home/vuvudev/apps/umlbasicai-fe/production'

steps:
  - checkout: self

  # Dùng Node 18
  - task: UseNode@1
    inputs:
      version: '$(NODE_VERSION)'

  # Cài package
  - script: npm install
    displayName: 'Install dependencies'

  # Build app
  - script: npm run build
    displayName: 'Build Next.js app'

  # Nén toàn bộ project cần thiết vào file zip
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Build.SourcesDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(ZIP_NAME)'
      verbose: true

  # Upload file zip qua SSH
  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'AzureVPS'
      sourceFolder: '$(Build.ArtifactStagingDirectory)'
      contents: '$(ZIP_NAME)'
      targetFolder: '/home/vuvudev/deploy-temp'

  # SSH vào VPS để giải nén, cài package và chạy app bằng PM2
  - task: SSH@0
    inputs:
      sshEndpoint: 'AzureVPS'
      runOptions: 'commands'
      commands: |
        set -e

        echo "📁 Tạo thư mục đích nếu chưa có"
        mkdir -p $(APP_DIR)

        echo "📦 Giải nén project..."
        unzip -o /home/vuvudev/deploy-temp/$(ZIP_NAME) -d $(APP_DIR)

        echo "🧹 Xóa file zip sau khi giải nén"
        rm /home/vuvudev/deploy-temp/$(ZIP_NAME)

        cd $(APP_DIR)

        echo "🧪 Kiểm tra Node.js và PM2..."
        if ! command -v node > /dev/null; then
          echo "⚙️ Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
        fi

        if ! command -v pm2 > /dev/null; then
          echo "⚙️ Installing PM2..."
          sudo npm install -g pm2
        fi

        echo "📦 Cài dependencies..."
        npm install

        echo "🔧 Rebuild app lần nữa nếu cần..."
        npm run build

        echo "🚀 Restart hoặc start bằng PM2..."
        pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
