trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '18.x'
  ZIP_NAME: 'umlbasicai-fe.zip'
  APP_DIR: '/home/vuvudev/apps/umlbasicai-fe/production'

steps:
  - checkout: self

  # DÃ¹ng Node 18
  - task: UseNode@1
    inputs:
      version: '$(NODE_VERSION)'

  # CÃ i package
  - script: npm install
    displayName: 'Install dependencies'

  # Build app
  - script: npm run build
    displayName: 'Build Next.js app'

  # NÃ©n toÃ n bá»™ project cáº§n thiáº¿t vÃ o file zip
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Build.SourcesDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(ZIP_NAME)'
      verbose: true

  # Upload file zip qua SSH
  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'AzureVPS'
      sourceFolder: '$(Build.ArtifactStagingDirectory)'
      contents: '$(ZIP_NAME)'
      targetFolder: '/home/vuvudev/deploy-temp'

  # SSH vÃ o VPS Ä‘á»ƒ giáº£i nÃ©n, cÃ i package vÃ  cháº¡y app báº±ng PM2
  - task: SSH@0
    inputs:
      sshEndpoint: 'AzureVPS'
      runOptions: 'commands'
      commands: |
        set -e

        echo "ğŸ“ Táº¡o thÆ° má»¥c Ä‘Ã­ch náº¿u chÆ°a cÃ³"
        mkdir -p $(APP_DIR)

        echo "ğŸ“¦ Giáº£i nÃ©n project..."
        unzip -o /home/vuvudev/deploy-temp/$(ZIP_NAME) -d $(APP_DIR)

        echo "ğŸ§¹ XÃ³a file zip sau khi giáº£i nÃ©n"
        rm /home/vuvudev/deploy-temp/$(ZIP_NAME)

        cd $(APP_DIR)

        echo "ğŸ§ª Kiá»ƒm tra Node.js vÃ  PM2..."
        if ! command -v node > /dev/null; then
          echo "âš™ï¸ Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
        fi

        if ! command -v pm2 > /dev/null; then
          echo "âš™ï¸ Installing PM2..."
          sudo npm install -g pm2
        fi

        echo "ğŸ“¦ CÃ i dependencies..."
        npm install

        echo "ğŸ”§ Rebuild app láº§n ná»¯a náº¿u cáº§n..."
        npm run build

        echo "ğŸš€ Restart hoáº·c start báº±ng PM2..."
        pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
