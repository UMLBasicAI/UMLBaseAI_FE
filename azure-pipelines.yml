trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '18.x'
  ZIP_NAME: 'umlbasicai-fe.zip'
  APP_DIR: '/home/vuvudev/apps/umlbasicai-fe/production'

steps:
  - checkout: self

  # DÃ¹ng Node 18
  - task: UseNode@1
    inputs:
      version: '$(NODE_VERSION)'

  # NÃ©n project loáº¡i trá»« node_modules, .next, deploy-temp...
  - task: Bash@3
    displayName: 'Zip project without node_modules'
    inputs:
      targetType: 'inline'
      script: |
        echo "ğŸ“¦ Zipping project without node_modules and unnecessary folders"
        zip -r $(Build.ArtifactStagingDirectory)/$(ZIP_NAME) . \
          -x "**/node_modules/*" "**/.next/*" "**/deploy-temp/*" "**/.git/*" "**/.vscode/*"

  # Upload file zip lÃªn VPS
  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'AzureVPS'
      sourceFolder: '$(Build.ArtifactStagingDirectory)'
      contents: '$(ZIP_NAME)'
      targetFolder: '/home/vuvudev/deploy-temp'

  # SSH vÃ o VPS Ä‘á»ƒ deploy app
  - task: SSH@0
    displayName: 'SSH deploy and run app'
    inputs:
      sshEndpoint: 'AzureVPS'
      runOptions: 'inline'
      inline: |
        set -e

        echo "ğŸ“‚ Clean old production folder (optional)"
        rm -rf $(APP_DIR)
        mkdir -p $(APP_DIR)

        echo "ğŸ“¦ Extracting zip to $(APP_DIR)..."
        unzip -o /home/vuvudev/deploy-temp/$(ZIP_NAME) -d $(APP_DIR)

        echo "ğŸ§¹ Removing uploaded zip..."
        rm /home/vuvudev/deploy-temp/$(ZIP_NAME)

        echo "ğŸ“ Navigating to app directory"
        cd $(APP_DIR)

        echo "ğŸ§ª Checking for Node.js..."
        if ! command -v node > /dev/null; then
          echo "âš™ï¸ Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt install -y nodejs
        fi

        echo "ğŸ§ª Checking for PM2..."
        if ! command -v pm2 > /dev/null; then
          echo "âš™ï¸ Installing PM2 globally..."
          sudo npm install -g pm2
        fi

        echo "ğŸ“¦ Installing project dependencies..."
        echo "ğŸ§¹ Cleaning before install"
        rm -rf node_modules
        rm -rf .next
        npm install --loglevel=error --no-fund --no-audit


        echo "ğŸ”§ Building Next.js app..."
        npm run build

        echo "ğŸš€ Starting or restarting app with PM2..."
        pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
