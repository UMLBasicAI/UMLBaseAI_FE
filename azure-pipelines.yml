trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '18.x'
  ZIP_NAME: 'umlbasicai-fe.zip'
  APP_DIR: '/home/vuvudev/apps/umlbasicai-fe/production'

steps:
  - checkout: self

  # DÃ¹ng Node 18
  - task: UseNode@1
    inputs:
      version: '$(NODE_VERSION)'

  # CÃ i package
  - script: npm install
    displayName: 'Install dependencies'

  # Build app
  - script: npm run build
    displayName: 'Build Next.js app'

  # NÃ©n toÃ n bá»™ project cáº§n thiáº¿t vÃ o file zip
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Build.SourcesDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(ZIP_NAME)'
      verbose: true

  # Upload file zip qua SSH
  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'AzureVPS'
      sourceFolder: '$(Build.ArtifactStagingDirectory)'
      contents: '$(ZIP_NAME)'
      targetFolder: '/home/vuvudev/deploy-temp'

  # SSH vÃ o VPS Ä‘á»ƒ giáº£i nÃ©n, cÃ i package vÃ  cháº¡y app báº±ng PM2
  - task: SSH@0
    displayName: 'SSH into VPS to extract and run the app'
    inputs:
      sshEndpoint: 'AzureVPS'
      runOptions: 'inline'
      inline: |
        set -e

        echo "ğŸ“¦ Extracting zip..."
        unzip -o /home/vuvudev/deploy-temp/umlbasicai-fe.zip -d /home/vuvudev/apps/umlbasicai-fe/production

        echo "ğŸ§¹ Deleting zip file after extraction"
        rm /home/vuvudev/deploy-temp/umlbasicai-fe.zip

        echo "ğŸ“‚ Navigating to project directory"
        cd /home/vuvudev/apps/umlbasicai-fe/production

        echo "ğŸ§ª Checking for Node.js and PM2..."
        if ! command -v node > /dev/null; then
          echo "âš™ï¸ Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt install -y nodejs
        fi

        if ! command -v pm2 > /dev/null; then
          echo "âš™ï¸ Installing PM2..."
          sudo npm install -g pm2
        fi

        echo "ğŸ“¦ Installing dependencies..."
        npm install

        echo "ğŸ”§ Building the app..."
        npm run build

        echo "ğŸš€ Restarting the app with PM2..."
        pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js

